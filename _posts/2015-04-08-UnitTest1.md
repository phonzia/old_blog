---
layout: post
title: "C++单元测试总结系列（一）——导言"
---
#导言

##为什么要写这个总结？
从开始考虑必须在自己的代码中应用单元测试已经两年了。在此之前，也断断续
续地写了一些单元测试。但是每当碰到涉及socket或者数据库相关的测试时，总
还是不知所措，不知如何去针对这些代码做好测试。直到最近接触了Fake和Mock
这样的概念，以及相关的一些方法，才总算是有所领悟。花费了数天的时间仔细
地看了gtest和gmock的使用部分文档，能够开始在项目中更好地应用单元测试。
虽然仍然需要更多的时间练习，但是已经是一个开始。把这个总结写下来，希望
其他希望进行单元测试的人，无需像我一样走这么多弯路。

##单元测试是什么？
单元测试一般是针对一个系统最为原子的行为单元的测试。比如过程式语言中的
函数或者说面向对象语言中的类。
<!--more-->

##单元测试的作用
虽然覆盖代码更广泛的功能也很重要，但是较大型的测试存在一些问题：

1. 难以定位错误。测试离被测对象更远，关联的其他因素越多，当测试失败时，
   就越难定位问题的所在。
2. 执行时间太长。较大型的测试往往需要更多的时间来运行，这也意味着需要
   更多的时间来得到反馈。而因为花费的时间多，开发人员就越不愿意多次执
   行。
3. 覆盖面不足。因为测试离测试对象太远，往往很难确定某段代码和测试用例
   之间的关系，即使通过工具找出来未被覆盖的代码块，依然需要花费大量的
   脑筋去考虑如何增加用例去覆盖改代码块。

好的单元测试应该具有以下品质：

1. 运行快。
2. 能够帮我们定位问题所在。

##什么样的测试才是单元测试
理解什么是一个单元测试非常重要，分辨什么样的测试不是单元测试能够让我们
在编写可测试代码的时候更加有方向性。特别有些测试很容易和单元测试混淆起
来，比如以下测试就不是单元测试，即使我们通常也会使用单元测试框架编写这
些测试：

1. 和数据库有交互；
2. 进行了网络通讯；
3. 调用了文件系统；
4. 需要做特定准备（如编辑配置文件）才能运行；

对于初学者而言，最常见的情况就是在对一个包含数据库操作的类进行测试时，
没有对数据库操作做好隔离，而是搭建一个数据库环境，让测试代码直接连接数
据库。这样做和我们想要的好的单元测试有很大差别：

1. 测试环境搭建困难。单元测试代码无法在任何能够编译运行这个类的机器上
   运行，而是需要搭建一个数据库环境。即使所在的机器已经都搭建好的测试
   库环境，也无法保证该测试库不会因为其他原因被修改而导致无法满足测试
   条件。
2. 运行效率较低。一个好的单元测试需要运行很快，而涉及数据库操作和网络
通讯会导致测试变慢。

##关于单元测试的误解
###单元测试增加工作量？
单元测试会大幅度增加我们需要编写的代码，但是这并不意味着会增加工作量。
经过练习，编写和调试单元测试所花费的时间并不一定会比覆盖范围更广的测试
所花费的更长。但是相比更广范围的测试（还可能是手工测试），单元测试有很
多优点：

1. 单元测试可以在很短的时间内运行结束。这意味着我们能够更快地得到反馈。
2. 单元测试更容易定位问题所在。在大范围测试中，追踪一个bug并不是一件容
   易的事，而由于单个单元测试覆盖面小的特点，我们可以更容易地锁定问题
   所在。
3. 单元测试可以反复使用，利于软件的维护。

所以，长期而言，单元测试能够减少我们的工作量。而即使在短期，单元测试也
未必比会增加工作量。

###单元测试能够替代其他测试？
单元测试并不能取代其他测试，更广范围的测试仍然是重要的。但是单元测试能
够更快的给出反馈，让我们更容易定位和解决其他测试中反应的问题，很多时候，
我们只需要在单元测试中增加缺漏的用例，就可以确定测试中反应的问题所在。

单元测试让集成测试更加轻松，但是单元测试无法取代集成测试。

##这一系列文章都会包含哪些内容？
按照目前的规划，主要分为以下几个部分，每个部分具体以几篇文章发出暂时没有确定：

1. C++单元测试覆盖率的检测。
2. GTest的使用介绍。
3. GMock的使用介绍。
4. 一些具体的例子。

因为个人的工作性质原因，所有的代码和方法都是针对Linux C++开发，由于对
于Windows不熟悉，暂时无法给出任何相关的经验说明。
